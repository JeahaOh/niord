
<admin-page admin-page-title="Message Templates" parent-page="sysadmin" parent-page-title="Sysadmin">

    <div ng-controller="TemplatesAdminCtrl" ng-init="loadTemplates()">

        <p>Add, modify and manage templates used for generating messages.<br>
            Displaying {{searchResult.size}}
            of {{searchResult.total}} templates matching search criteria.</p>

        <form id="templateForm" name="templateForm" class="form-horizontal">

            <!-- Add/edit template -->
            <div ng-if="template !== undefined" style="margin-top: 20px">

                <div class="row">
                    <div class="form-controls col-sm-12 col-md-12 col-lg-8">

                        <div class="form-group">
                            <label class="col-sm-4">Category</label>
                            <div class="col-sm-8">
                                <categories-field category-data="template" multiple="false"
                                                  category-changed="categoryChanged()"></categories-field>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-4">Name</label>
                            <div class="col-sm-8">
                                <div class="row">
                                    <div class="col-sm-12 col-md-6" ng-repeat="desc in template.descs">
                                        <input class="form-control input-sm" placeholder="Name" type="text" ng-model="desc.name" ng-required="$first"
                                               bg-flag="desc.lang">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-4">Domains</label>
                            <div class="col-sm-8">
                                <domain-field domain-data="template" multiple="true"></domain-field>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-4">Script Resources</label>
                            <div class="col-sm-8" ng-sortable="pathsSortableCfg">
                                <div ng-repeat="path in template.scriptResourcePaths">
                                    <div class="input-group">
                                        <span class="input-group-addon" style="font-size: 12px">
                                            {{$index + 1}}: <span class="glyphicon glyphicon-move move-btn"></span>
                                        </span>
                                        <input type="text" class="form-control input-sm"
                                               id="path_{{$index}}"
                                               pattern=".+\.(ftl|FTL|js|JS)" required
                                               ng-model="template.scriptResourcePaths[$index]" />
                                        <a class="input-group-addon clickable" style="font-size: 12px"
                                           href target="_blank" title="Edit resource"
                                           ui-sref="sysadmin.script-resources({ 'path': path })">
                                            <span class="glyphicon glyphicon-pencil"></span>
                                        </a>
                                        <a class="input-group-addon clickable" style="font-size: 12px"
                                            ng-click="addResourcePath($index)"  title="Add resource">
                                            <span class="glyphicon glyphicon-plus"></span>
                                        </a>
                                        <a class="input-group-addon clickable" style="font-size: 12px"
                                            ng-click="deleteResourcePath($index)"  title="Delete resource">
                                            <span class="glyphicon glyphicon-trash"></span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-4">Example Message</label>
                            <div class="col-sm-6">
                                <message-id-field reference="template"></message-id-field>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-4">Test</label>
                            <div class="col-sm-6">
                                <message-id-field reference="testMessageData"></message-id-field>
                            </div>
                            <div class="col-sm-2">
                                <button type="submit" class="btn btn-default btn-sm" style="width: 100%"
                                        ng-click="executeTemplate(template)" ng-disabled="testMessageData.messageId === undefined">
                                    Test...
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <div style="margin-top: 20px;" class="row">
                    <div class="col-sm-offset-4">
                        <button type="submit" class="btn btn-default btn-sm" ng-click="loadTemplates()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary btn-sm" ng-click="saveTemplate(template)"
                                ng-disabled="templateForm.$pristine || templateForm.$invalid">
                            <span class="glyphicon glyphicon-floppy-disk"></span>
                            Save Template
                        </button>
                    </div>
                </div>
            </div>


            <!-- List templates -->
            <div ng-if="template === undefined">

                <div class="row" style="margin-top: 20px; margin-bottom: 10px">
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                        <input class="form-control input-sm col-sm-2" ng-model="params.name" type="text" placeholder="Name"
                               ng-model-options="{ updateOn: 'default blur', debounce: { default: 500, blur: 0 } }">
                        <span class="glyphicon glyphicon-remove clear-input" style="right: 22px"
                              ng-click="params.name = ''" ng-show="params.name != ''"></span>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                        <categories-field category-data="params" multiple="false"></categories-field>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                        <domain-field domain-data="params" multiple="false"></domain-field>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                        <button type="submit" class="btn btn-primary btn-sm" ng-click="addTemplate()">
                            <span class="glyphicon glyphicon-plus"></span> New Template
                        </button>

                        <span class="btn-group" style="margin-left: 5px;" uib-dropdown>
                            <button id="single-button" type="button" class="btn btn-primary btn-sm" uib-dropdown-toggle>
                                <span class="glyphicon glyphicon-cog"></span>
                                <span class="caret"></span>
                            </button>
                            <ul uib-dropdown-menu role="menu" aria-labelledby="single-button">
                                <li role="menuitem"><a href ng-click="exportTemplates()">Export...</a></li>
                                <li role="menuitem"><a href ng-click="uploadTemplatesDialog()">Import...</a></li>
                            </ul>
                        </span>
                    </div>
                </div>

                <div class="row" style="padding-top: 20px;">
                    <div class="col-sm-12 col-md-12">
                        <table class='table table-condensed table-hover'>
                            <tr>
                                <th>Category</th>
                                <th>Name</th>
                                <th>Domains</th>
                                <th>Script Resources</th>
                                <th></th>
                            </tr>
                            <tr ng-repeat="template in searchResult.data">
                                <td>{{template.category.descs[0].name}}</td>
                                <td><span ng-if="template.descs && template.descs.length > 0">{{template.descs[0].name}}</span></td>
                                <td>
                                    <div ng-repeat="domain in template.domains">{{domain.name}}</div>
                                </td>
                                <td>
                                    <div ng-repeat="path in template.scriptResourcePaths">{{path}}</div>
                                </td>
                                <td nowrap align="right">
                                    <a href ng-click="editTemplate(template);" title="Edit Template">
                                        <i class="glyphicon glyphicon-pencil"></i></a>
                                    &nbsp;
                                    <a href ng-click="copyTemplate(template);" title="Copy Template">
                                        <i class="glyphicon glyphicon-duplicate"></i></a>
                                    &nbsp;
                                    <a href ng-click="deleteTemplate(template);" title="Delete Template">
                                        <i class="glyphicon glyphicon-trash"></i></a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="row">
                    <div class="col-sm-12">
                        <uib-pagination total-items="searchResult.total" items-per-page="pageData.maxSize"
                                        max-size="pageData.maxSize" ng-model="pageData.page"
                                        class="pagination pagination-sm" previous-text="&lsaquo;"  next-text="&rsaquo;"
                                        boundary-links="true" first-text="&laquo;" last-text="&raquo;">
                        </uib-pagination>
                    </div>
                </div>

            </div>

        </form>
    </div>

</admin-page>


<!-- ************************************************** -->
<!-- Dialog for displaying result of executing template -->
<!-- ************************************************** -->
<script type="text/ng-template" id="templateResultDialog.html">
    <div class="modal-header">
        <h4 class="modal-title">Template Result</h4>
    </div>
    <div class="modal-body">

        <div class="container-fluid">

            <div class="row">
                <div class="col-sm-12">
                    <div class="message-status-lang">
                        <span ng-repeat="lang in modelLanguages" ng-click="previewLanguage(lang)"
                              class="message-status-lang-btn pointer" ng-class="{'preview-lang-selected' : previewLang == lang}">
                            <img ng-src="/img/flags/{{lang}}.png" height="14"/>
                            {{'lang.' + lang | translate}}
                        </span>
                    </div>

                    <table ng-if="message.id" class='table table-condensed'>
                        <tr render-message-details
                            msg="previewMessage"
                            language="previewLang"
                            format="details"
                            show-promulgation="true"
                            show-details-menu="false"></tr>
                    </table>
                </div>
            </div>

        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-default" ng-click="$dismiss('cancelled')">Close</button>
    </div>
</script>
